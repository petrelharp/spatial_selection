% \documentclass{article}
% \usepackage{fullpage}
% \input{review-response-commands}
% 
% \begin{document}

\section*{From the editor}

\begin{minipage}[b]{2.5in}
  Resubmission Cover Letter \\
  {\it PLoS Genetics}
\end{minipage}
\hfill
\begin{minipage}[b]{2.5in}
    Molecular and Computational Biology\\
    University of Southern California, \\
    \emph{and} Evolution and Ecology\\
    University of California at Davis\\
  \today
\end{minipage}
 
\vskip 2em
 
\noindent
{\bf To the Editor(s) -- }
 
\vskip 1em


\begin{quote}
    Both reviewer 1 and reviewer 2 still question your main result presented in Eq. 11 and I do agree with them that there is definitely something wrong with the dimensions. 
    % This was already pointed in the first round of reviews and both reviewers feel that this issue has not been satisfactorily addressed. 
\end{quote}

\begin{quote}
    Both reviewer also argued in the first round that the derivations in the paper are overly complicated and that the problem can in fact be intuitively understood via much simpler arguments (both came up with very similar approaches independently). 
    You stated in your replies that you prefer to stick with your derivation because you consider it more solid. 
    However, I am not even fully convinced that your Eq. 11 is more correct than the reviewers' intuitive results. 
\end{quote}

\begin{quote}
    Reviewer 1 points out that there are quite substantial deviations in your numerical results (Fig. 4) and reviewer 2 stresses that the 1D simulations won't even be able to catch the potential problems associated with the boundary of the target area. Clearly, something is not yet fully understood here and I don't see how the paper can be accepted without having settled these issues.
\end{quote}

% \begin{quote}
    % It would be easy to simply reject the paper at this point.  However, as I expressed earlier, I still think that this is an extremely interesting problem that could be of great relevance for future studies, given that the authors can convincingly resolve the issues raised above. The dimensionality problem clearly needs to be resolved, and it needs to be explained how their result and the intuitive results from the reviewers compare with each other.
% \end{quote}

\begin{quote}
    I also think that presenting and discussing the intuitive results really would be important for the paper, as originally suggested by reviewers 1 and 2. There is a tendency in population genetics to derive complicated ``exact'' results that are nonetheless of only limited usefulness in reality because it's unclear how realistic the underlying models are in the first place. I won't hide here that I strongly prefer a heuristic approach that reveals what's actually going on, over a lengthy technical calculation that may be formally more correct, yet it's unclear whether this really matters in reality. I feel the majority of the audience of PLoS Genetics is probably with me on this.
\end{quote}

% \begin{quote}
%     Should you decide to tackle these problems in a major revision, please also address the remaining comments raised by the reviewers. Sorry that I can't bring you better news at this point but I think you will agree that the reviews are pretty clear in what needs to be done in order to get this paper accepted in PLoS Genetics.
% \end{quote}

\noindent \hspace{4em}
\begin{minipage}{3in}
\noindent
{\bf Sincerely,}

\vskip 2em

{\bf Peter Ralph, and\\
Graham Coop.}\\
\end{minipage}

\vskip 4em

\reply


The main change,
which addresses most of the concerns,
is that we uncovered an error in the derivation of equation \eqref{eqn:migrate},
that supplied the missing factor of area noted by the reviewers.
The error occurred in the transition between section \nameref{ss:heuristics} 
and section \nameref{ss:hitting_occupation}
because in the former we had tried to keep things simple
by not including shape of the patch in
gestalt equations \eqref{eqn:gestalt_q} and \eqref{eqn:gestalt_migrate},
but then (more correctly) treated the shape in the latter;
effectively we were treating the patch as very small in one place
and large in another.
We've rewritten the argument in \nameref{ss:heuristics} 
to deal explicitly with the integral over the whole patch,
which also necessitated adding a new (short) section \nameref{apx:qS}.
Section \nameref{ss:hitting_occupation} required very little change.

We also turned up a minor bug in the discussion of conditioned branching processes:
the exact picture is not quite so simple,
but the approximate picture is still the same --
see around \llname{ll:branching_process_fix}.



%%%%%%%%%%%%%%
\reviewersection

%%%%%%
\point{}{
    The issue of dimensions and geometry of the target patch is the main difficulty I have with the paper. I just don't see how your equation \eqref{eqn:migrate} can be correct. It has dimensions of 1/time/area when it should be 1/time. Somehow the target area needs to play a role. Reviewer 2 has raised similar issues.
}

\reply
Now that we've found the problem in the derivation,
we heartily agree;
the missing factor was, indeed, a multiplicative factor of area.
(See above for more on this.)


%%%%%%
\point{}{
Regarding the simulations presented in Fig 4, I don't think they strongly support the functional form of $\migrate$. Points with very similar observed migration time have predicted migration times that differ by a factor of a 100 (the more extreme are outside the validity of the approximations, but still I don't think this figure is strong evidence that the math is correct.)
}

\reply
We think the main issue here was inclusion of points outside the validity of the approximations,
since of the parameters falling in the range of validity discussed in \nameref{ss:assumptions},
the largest discrepancy was a factor of 7, not 100.
We've re-made this figure only using parameter combinations that fall within the range of validity
($R > \sigma/\sqrt{s_m}$, patch width larger than $\sigma/\sqrt{s_m} \atan(\sqrt{s_m/s_b})$, and $2 s_m \sigma N > 1$);
%         ( R*sqrt(abs(sm))/sigma > 1 ) & 
%         ( size2 > (sigma/sqrt(abs(sm)))*atan(sqrt(abs(sm/gb))) ) &
%         ( abs(sm) * 2 * sigma * N > 1 )
the figures that include all simulation results are still included in the supplement
(and hopefully will inspire theory that is applicable in the other regions).

%%%%%%
\point{eq.~56 is wrong}{
    as easily seen with $\Theta=0$ \ldots
    so eq.~56 has an extra 2, resulting from a wrong expansion of $\sqrt{1+x}$,
    and so eq.~57--61 are also wrong.
}

\reply
Thanks for catching that mistake.  
% We removed the extra factor of 2 (section~\secref{apx:outflux}).
However, in the interest of shortening the paper, we decided to remove that section.


%%%%%%
\point{time in transit}{
    One can obtain these results by a simple saddle point approximation:
    \begin{align*}
        \P\{ \text{getting to $x$ in time $t$} \} &= \P\{\text{diffusion to $x$ in time $t$}\} \P\{\text{surviving}\} \\
                                                  &= \frac{1}{(2\pi\sigma^2)^{d/2}} e^{-\frac{x^2}{2\sigma^2 t}-st}
    \end{align*}
    the exponent is minimal when
    \[
        \frac{x^2}{2\sigma^2 t^2} = s \quad \Rightarrow \quad t^* = \frac{x}{\sigma\sqrt{2s}},
    \]
    this gives your eq.~17.
    The variance is simply the inverse of the second derivative of the exponent
    \[
        \frac{1}{\var[\tau]} = \frac{x^2}{\sigma^2 (t^*)^3} = \frac{\sigma}{x(2s)^{3/2}} .
    \]
}

\reply
This is a nice point;
perhaps which approach should be included
comes down to personal taste
as to whether ``saddle point approximation'' or ``Laplace transform'' is a simpler idea?  
We decided to stick with the Laplace transform.

%%%%%%
\point{now to the thornier issues of dimension, geometry, and fluxes}{
    \begin{itemize}
        \item {} [with $\ell = \sigma/\sqrt{2s}$, $r$ the radius of the patch, $R$ the distance between patches, and $\ell \ll r \ll R$]
        \item the average density is $q(x) \sim e^{-x/\ell}$
        \item but fluctuates far from the source as [families of size $K$, with local density $K/\ell^d$]
        \item families of size $1/s$ live for $1/s$ generations and hence contribute $1/s^2$ to the time-averaged density $q(x)$
        \item \[ q(x) = \lambda_\text{arr}(x) / s^2 \ell^d, \]
            where $\lambda_\text{arr}(x)$ is the rate at which families arrive that overlap with $x$
        \item \[ \lambda_\text{arr}(x) = q(x) s^2 \ell^d \]
            and
            \[ \Lambda_\text{arr}(x) = \lambda(x) \ell^d = q(x) s^2 \]
            would be an ``arrival density''
        \item to get at $\migrate$, arrival needs to be integrated over the relevant area. In $d=1$ this is simply a stretch of length $\ell$,
            in $d=2$ it should be $\sqrt{\ell^3 r}$,
            hence one should get
            \[ \migrate \sim \rho q(x) s^2 \ell^d \sqrt{r/\ell} (1-e^{-p_e/s}) \]
        \item result does depend on target geometry
    \end{itemize}
}

\reply
As discussed above,
we've debugged the issue about dimensions,
so that the argument now correctly does integrate over the new patch.
The result does depend on target geometry, just as the reviewer points out (thanks!);
this is now discussed in section \secref{apx:qS}.
The other part of this argument, as we understand it,
modifies terms in \eqref{eqn:migrate}
by specifying a form for $A$, the relevant area of the new patch,
and postulating a specific form for $K$.
We've opted not to make these changes,
since these require additional assumptions,
and it feels easier on the reader to not require them to parse such assumptions.


\point{Formulation in terms of fluxes}{(suggested by reviewer 2) might be easier.}

\reply
Perhaps; we've gone the even easier route of working with $q(S)$ and $\migrate(S)$ rather than densities.


%%%%%%%%%%%%%%  Reviewer 2
\reviewersection

%%%%%%
\point{}{
I still think that the main result (11) is dimensionally inconsistent -- it needs to be integrated over the boundary layer of the patch. In their response to my original review, the authors just referred to their response to a similar point by reviewer 1, but I don't think that this addresses my concern -- reviewer 1 was talking about integrating over a different area, the one occupied by a family, which I agree is not correct. (Note that the 1D simulations aren't going to be able to catch this issue, since you can't play with the length of the boundary.)
}

\reply
As discussed above, we fixed this.
And, apologies for not catching on in the first round of reviews.


%%%%%%
\point{}{
I do think that reviewer 1 raises a good point though. Looking back through the manuscript, I can't find where the authors show that the family is localized within a length scale $\sim \sigma/\sqrt{s_m} \ll A^{1/d}$. This is important, since it's needed to justify the approximation that the whole family arrives at the patch together. This seems like a basic fact about subcritical branching random walks/Brownian motions, so there's probably a formal proof of it somewhere in the literature, but I think that it's straightforward to give an intuitive explanation.
}

\reply
Good point; this works out nicely: \revref.


%%%%%%
\point{}{
Speaking of the literature, what's known about hitting probabilities for subcritical branching random walks/Brownian motions?
}

\reply
In general, we could write down differential equations
that tell us what we want to know.
There are at least two approaches: 
ignore the old patch, and simply ask for the probability of establishment;
or include the old patch, and ask about the transform of the occupation time in the new patch,
$\E[\exp(-\int_0^t \langle Z_s, p_e \rangle ds)]$.
For instance,
if $Z$ is a continuous-time Markovian branching process
whose spatial motion has generator $A$,
that when at location $x$, branches at rate $r(x)$,
producing a number of 
offspring whose distribution has generating function $\Psi_x(u)=\E^x[u^W]$.
Then if $f(x)$ denotes the probability of nonextinction
of a process beginning with a single individual at $x$,
\begin{align*}
    Af(x) + r(x) (\Psi_x(f(x))-f(x)) = 0 .
\end{align*}
This is the approach taken by \citep{barton1987establishment};
we chose not to go this route because thinking explicitly about the decomposition into families
seems much more interesting and useful.
There is a large and diverse literature on branching Brownian motion,
but the majority of it is devoted to critical or supercritical Brownian motion.
We haven't been able to dig up anything that gives the sort of asymptotics that we need;
but it may well be out there; pointers are welcome.


%%%%%%
\point{}{
I still think that the derivation of the main result is too complicated, and could be made much simpler along the lines of the suggestion in my previous review. The extra complications introduced in the current version do not actually make the result any more rigorous -- they just take a less direct route to introducing the same approximations.
}

\reply
It's true, that in the case that $p_e < s_m$ we get the same result
as what is obtained ignoring correlations in arrivals
(e.g., by the Fick's law argument of the previous review).
To our taste, the "complications" make the paper more digestible,
since it is more clear what's going on,
especially to those who are less familiar with branching processes.

That said, we do go beyond these approximations, since we include the case $p_e > s_m$,
where family structure matters --
so, we're not clear how to address this.


%%%%%%
\point{}{
I don't totally understand the simulation methods. The authors say that individuals first chose whether or not to reproduce with probability depending on their fitness, and then produced a Poisson-distributed number of offspring. So the selection is all in whether or not individuals reproduce, not in the number of offspring conditioned on reproduction? What exactly was the function for the probability of reproduction, and what was the mean of the offspring distribution? I'm just wondering if there's a detail here that would account for the discrepancy between the analysis and the simulations. Also, it would be helpful to say exactly what the value of sigma is in the chosen migration model.
}

\reply
Whoops -- we had erroneously left in that statement that the number of offspring each step was Poisson;
in fact, the number of offspring produced in a generation is either 0 or 1.
The exact function is given in the next paragraph \revref,
and as detailed there, we don't naively assume
that whatever we labeled \texttt{sm} in the code
is actually what we mean by $s_m$ in the theory.
We've also added a note about what $\sigma$ is \llname{rr:sim_details}.

%%%%%%
\point{}{
I'm not sure that the description of the valid parameter range in "A review, and a test of the assumptions" is entirely correct. For the mutation results, it's fine if $s_m$ and $s_p$ have very different magnitudes, as long as the patches are sufficiently big/migration is sufficiently weak. What precisely is the condition here?
}

\reply
Good point; we've been more precise about these conditions. \revref


%%%%%%
\point{}{
In the Applications, I understand that there's still a lot to learn about this system, but the authors need to at least say how far apart the actual lava flow patches are, so we have a sense of what their estimate of "tens to a few hundred kilometers" means for mutation vs migration.
}

\reply
That's a trickier question than it at first seems,
but we've added a rough idea \revref.


%%%%%%
\point{}{
In their response to my comments, the authors said that they did not see why the assumption $R \gg w$ was necessary. I think that it is needed in order to talk sensibly about a single "distance to a patch" $R$: if $w \gtrsim R$, then generally some parts of the patch will be much closer than others, right?
}

\reply
Ah, right.
By "distance to a patch" we mean the length of the shortest path beginning in one and ending in the other.
We've clarified this \revref.
Given this, and the caveats around how to calculate $A$ in \eqref{eqn:migrate},
we still don't think the assumption is necessary?


%%%%%%
\point{}{
I still think that including any sub-leading terms in the length of the shared haplotype is falsely precise.
}

\reply
We would agree, but it's not certain which of the various terms 
in \eqref{eqn:haplotype_length} and the subsequent equation for $\var[L]$
are the leading ones,
depending on how $s_m$ compares to $R/\sigma$.




%%%%%%%%%%%%%%
\reviewersection

\begin{quote}
I appreciate the careful and thorough revision - and especially the exhaustive simulation work. It is an impressive and truly content-rich manuscript. I have only a few minor points:
\end{quote}

%%%%%
\point{Figure 1:}{
    point panel, $s_m = -0.02$ appears twice and $s_b$ should rather be $s_p$?
}

\reply
We intended for $s_m$ to appear twice, since the selection coefficient is -0.02 on both sides.  Good point about $s_b$; fixed.


%%%%%
\point{Figure 4:}{
    The new figure is a bit hard to read: the grey symbols are hardly visible, square symbols appear with two meanings, the colours for the filling do not match the legend ... Maybe reduce the number of parameter combinations shown (drop some intermediate values) to focus on the "main message" and get a clearer picture? - Details can still be given in the supplement.
}

\reply
Good catch about the colors and the squares; we've fixed that.
Also, as noted above, we've dropped the simulations that don't fall within the range of validity;
hopefully this unclutters things sufficiently?


%%%%%
\point{Figure 4:}{
    Mention all simulation parameters in the legend.
}

\reply
Done.


%%%%%
\point{point 169:}{
}{
    my name in acknowledgements is enough, cut here
}

\reply
OK as revised? \revref


%%%%%
\point{line 176:}{
    *we* provide (?)
}

\reply
Yes!  Thanks. \revref


%%%%%
\point{line 262:}{
    cut "depends" (?)
}

\reply
Also done, thanks.


%%%%%
\point{line 263:}{
    time to reach 100 B alleles: simulations should show how long this takes $\to$ can this explain anything or is it irrelevant? (Unclear in Fig 4 since value for $s_p$ is not provided).
}

\reply
In all the simulations, we fixed $s_p=0.01$ (now stated),
which measured in terms of instantaneous growth is a selection coefficient of about 0.002.
It's not at all straightforward to determine when the originating mutation arose,
since this would require tracing lineages back -- doable, but a lot more work.
Also, it seems that the second issue -- not really treating the boundary correctly
-- is more significant than the time the numbers take to go from 1 to 100.
Taking these two together,
and not wanting to further complicate the paper,
we decided to not try to pursue this farther.

